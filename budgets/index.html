<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PFOS · Budgets</title>
  <link rel="stylesheet" href="../assets/theme.css"/>
</head>
<body>
  <div class="container">
    <div class="widget">
      <div class="topbar">
        <div class="title">Budgets & Spending</div>
        <div class="controls">
          <div class="control">
            <label>Month</label>
            <select id="month"></select>
          </div>
          <button class="btn" id="editBudgets">Set budgets</button>
          <button class="btn" id="demo">Load demo data</button>
          <a class="btn" href="../">Home</a>
        </div>
      </div>

      <div class="twocol" style="padding-top:16px">
        <div class="block">
          <h3>Category performance</h3>
          <div class="tableWrap" style="padding:0">
            <table class="table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th class="right">Budget</th>
                  <th class="right">Spent</th>
                  <th class="right">Remaining</th>
                  <th style="width:180px">% Used</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>

        <div class="block">
          <h3>Overspend alerts</h3>
          <div id="alerts" style="display:flex; flex-direction:column; gap:10px"></div>
          <div class="sep"></div>
          <div style="font-size:12px; color:rgba(234,241,255,.62); line-height:1.6">
            Tip: Keep budgets only for expense categories. Income/Transfers are ignored here.
          </div>
        </div>
      </div>

      <div class="footerNote">Runs locally. No server-side storage.</div>
    </div>
  </div>

  <div class="drawer" id="drawer">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <h2>Set budgets</h2>
      <button class="btn small" id="close">Close</button>
    </div>
    <div style="font-size:12px; color:rgba(234,241,255,.62); margin-top:-4px">Budgets are saved locally in your browser.</div>
    <div class="sep"></div>

    <div id="budgetForm"></div>

    <div class="sep"></div>
    <div style="display:flex; justify-content:flex-end; gap:10px">
      <button class="btn" id="cancel">Cancel</button>
      <button class="btn primary" id="save">Save</button>
    </div>
  </div>

<script type="module">
  import { thisMonth, fmtINR, clamp } from "../assets/utils.js";
  import { getSettings, setSettings, seedIfEmpty, listTransactionsByMonth, onChanged } from "../assets/state.js";

  const profile = "default";
  const monthSel = document.getElementById("month");
  const rows = document.getElementById("rows");
  const alerts = document.getElementById("alerts");
  const demoBtn = document.getElementById("demo");

  const drawer = document.getElementById("drawer");
  const budgetForm = document.getElementById("budgetForm");
  const editBtn = document.getElementById("editBudgets");
  const closeBtn = document.getElementById("close");
  const cancelBtn = document.getElementById("cancel");
  const saveBtn = document.getElementById("save");

  let settings = null;

  function buildMonthOptions(){
    const now = new Date();
    const months = [];
    for(let i=0;i<18;i++){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      months.push(ym);
    }
    monthSel.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join("");
  }

  function openDrawer(){
    drawer.classList.add("open");
    const budgets = settings.budgets || {};
    const cats = (settings.categories||[]).filter(c => c !== "Income" && c !== "Investments");
    budgetForm.innerHTML = cats.map(cat=>{
      const v = budgets[cat] ?? "";
      return `
        <div class="field">
          <div class="lbl">${cat}</div>
          <input data-cat="${cat}" type="number" step="1" min="0" value="${v}"/>
        </div>
      `;
    }).join("");
  }
  function closeDrawer(){ drawer.classList.remove("open"); }

  async function render(){
    settings = await getSettings(profile);
    const currency = settings.currency || "INR";
    const ym = monthSel.value;

    const tx = await listTransactionsByMonth(profile, ym);
    const spent = new Map();

    for(const t of tx){
      if((t.type||"").toLowerCase() === "income") continue;
      if((t.type||"").toLowerCase() === "transfer") continue;
      const cat = t.category || "Uncategorized";
      spent.set(cat, (spent.get(cat)||0) + Number(t.amount||0));
    }

    const budgets = settings.budgets || {};
    const cats = Object.keys(budgets).sort((a,b)=> a.localeCompare(b));

    const overs = [];
    const body = cats.map(cat=>{
      const b = Number(budgets[cat]||0);
      const s = Number(spent.get(cat)||0);
      const rem = b - s;
      const used = b>0 ? (s/b)*100 : 0;
      const pct = Math.round(used);
      let cls = "good";
      if(used >= 100) cls = "bad";
      else if(used >= 80) cls = "warn";

      if(used >= 100) overs.push({cat, s, b});

      const barW = clamp(used, 0, 140);
      return `
        <tr>
          <td><span class="pill">${cat}</span></td>
          <td class="right mono">${fmtINR(b, currency)}</td>
          <td class="right mono">${fmtINR(s, currency)}</td>
          <td class="right mono">${fmtINR(rem, currency)}</td>
          <td>
            <div style="display:flex; align-items:center; gap:10px">
              <div class="progress ${cls}" style="flex:1"><div style="width:${barW}%"></div></div>
              <div class="mono" style="width:42px; text-align:right">${pct}%</div>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    rows.innerHTML = body || `<tr><td colspan="5" style="color:rgba(234,241,255,.60); padding:16px">No budgets set yet. Click “Set budgets”.</td></tr>`;

    if(overs.length === 0){
      alerts.innerHTML = `<div style="color:rgba(234,241,255,.60); font-size:13px">No overspends. Clean month.</div>`;
    }else{
      overs.sort((a,b)=> (b.s-b.b) - (a.s-a.b));
      alerts.innerHTML = overs.slice(0,5).map(o=>{
        return `<div class="card" style="min-height:auto">
          <div class="label"><span>${o.cat}</span><span class="chip bad">Over budget</span></div>
          <div style="margin-top:8px; font-size:13px; color:rgba(234,241,255,.82)">
            Spent <span class="mono">${fmtINR(o.s, currency)}</span> / Budget <span class="mono">${fmtINR(o.b, currency)}</span>
          </div>
        </div>`;
      }).join("");
    }
  }

  editBtn.onclick = ()=> openDrawer();
  closeBtn.onclick = closeDrawer;
  cancelBtn.onclick = closeDrawer;

  saveBtn.onclick = async ()=>{
    const inputs = budgetForm.querySelectorAll("input[data-cat]");
    const next = {...(settings.budgets||{})};
    inputs.forEach(inp=>{
      const cat = inp.getAttribute("data-cat");
      const v = Number(inp.value || 0);
      if(v > 0) next[cat] = v;
      else delete next[cat];
    });
    settings.budgets = next;
    await setSettings(profile, settings);
    closeDrawer();
    render();
  };

  demoBtn.onclick = async ()=>{ await seedIfEmpty(profile); render(); };

  buildMonthOptions();
  monthSel.value = thisMonth();
  monthSel.onchange = ()=> render();
  render();

  onChanged((ev)=>{
    if(ev.scope === "transactions" || ev.scope === "settings") render();
  });
</script>
</body>
</html>
