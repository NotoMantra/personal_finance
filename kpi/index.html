<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PFOS · KPI Dashboard</title>
  <link rel="stylesheet" href="../assets/theme.css"/>
</head>
<body>
  <div class="container">
    <div class="widget">
      <div class="topbar">
        <div class="title">Finance Dashboard</div>
        <div class="controls">
          <div class="control">
            <label>Month</label>
            <select id="month"></select>
          </div>
          <div class="control">
            <label>Profile</label>
            <select id="profile">
              <option value="default">Personal</option>
            </select>
          </div>
          <button class="btn" id="demo">Load demo data</button>
          <a class="btn" href="../">Home</a>
        </div>
      </div>

      <div class="grid kpis">
        <div class="card">
          <div class="label"><span>Net Cashflow</span><span class="badge">MTD</span></div>
          <div class="value" id="k_net">—</div>
          <div class="subrow">
            <span id="d_net" class="chip">—</span>
            <canvas class="spark" id="s_net"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="label"><span>Total Expense</span><span class="badge">MTD</span></div>
          <div class="value" id="k_exp">—</div>
          <div class="subrow">
            <span id="d_exp" class="chip">—</span>
            <canvas class="spark" id="s_exp"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="label"><span>Total Income</span><span class="badge">MTD</span></div>
          <div class="value" id="k_inc">—</div>
          <div class="subrow">
            <span id="d_inc" class="chip">—</span>
            <canvas class="spark" id="s_inc"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="label"><span>Savings Rate</span><span class="badge">MTD</span></div>
          <div class="value" id="k_sr">—</div>
          <div class="subrow">
            <span id="d_sr" class="chip">—</span>
            <canvas class="spark" id="s_sr"></canvas>
          </div>
        </div>
      </div>

      <div class="twocol">
        <div class="block">
          <h3>This month trend (weekly)</h3>
          <div class="canvasWrap"><canvas id="trend"></canvas></div>
          <div style="display:flex; gap:10px; margin-top:10px; color: rgba(234,241,255,.62); font-size:12px">
            <span class="pill dot" style="--dot:var(--accent)">Income</span>
            <span class="pill dot" style="--dot:var(--bad)">Expense</span>
          </div>
        </div>

        <div class="block">
          <h3>Top categories (expense)</h3>
          <div id="cats"></div>
        </div>
      </div>

      <div class="footerNote">Runs locally. No server-side storage. Use “Transactions” widget to add/edit rows.</div>
    </div>
  </div>

<script type="module">
  import { thisMonth, prevMonth, fmtINR, pct, drawSpark, drawLines } from "../assets/utils.js";
  import { getSettings, seedIfEmpty, listTransactionsByMonth, summarize, categoryTotals, weeklySeries, onChanged } from "../assets/state.js";

  const monthSel = document.getElementById("month");
  const profileSel = document.getElementById("profile");
  const demoBtn = document.getElementById("demo");

  function buildMonthOptions(){
    const now = new Date();
    const months = [];
    for(let i=0;i<18;i++){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      months.push(ym);
    }
    monthSel.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join("");
  }

  function chip(el, val){
    el.classList.remove("good","bad","warn");
    el.textContent = val;
  }

  function pctChip(el, p){
    el.classList.remove("good","bad","warn");
    if(p === null){ el.textContent = "—"; return; }
    const v = Math.round(p);
    el.textContent = (v>0?`+${v}%`:`${v}%`) + " vs last month";
    el.classList.add(v>=0 ? "good":"bad");
  }

  function buildCatBars(list, currency){
    if(!list.length){
      return `<div style="color:rgba(234,241,255,.60); font-size:13px">No expenses yet.</div>`;
    }
    const max = Math.max(...list.map(x=>x.amount)) || 1;
    return list.map(x=>{
      const w = Math.round((x.amount/max)*100);
      return `
        <div style="display:flex; align-items:center; gap:10px; margin: 10px 0">
          <div style="flex:1; min-width:0">
            <div style="display:flex; justify-content:space-between; gap:10px">
              <div style="font-size:13px; color:rgba(234,241,255,.88); white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${x.category}</div>
              <div class="mono" style="font-size:13px">${fmtINR(x.amount, currency)}</div>
            </div>
            <div class="progress" style="margin-top:8px"><div style="width:${w}%;"></div></div>
          </div>
        </div>`;
    }).join("");
  }

  async function render(){
    const profile = profileSel.value;
    const ym = monthSel.value;
    const settings = await getSettings(profile);
    const currency = settings.currency || "INR";

    const txThis = await listTransactionsByMonth(profile, ym);
    const txPrev = await listTransactionsByMonth(profile, prevMonth(ym));

    const a = summarize(txThis);
    const b = summarize(txPrev);

    // KPI values
    document.getElementById("k_net").textContent = fmtINR(a.net, currency);
    document.getElementById("k_exp").textContent = fmtINR(a.expense, currency);
    document.getElementById("k_inc").textContent = fmtINR(a.income, currency);

    const sr = (a.income>0) ? ((a.income-a.expense)/a.income)*100 : null;
    document.getElementById("k_sr").textContent = (sr===null) ? "—" : `${Math.round(sr)}%`;

    // KPI deltas vs last month
    pctChip(document.getElementById("d_net"), pct(a.net, b.net));
    pctChip(document.getElementById("d_exp"), pct(a.expense, b.expense));
    pctChip(document.getElementById("d_inc"), pct(a.income, b.income));
    pctChip(document.getElementById("d_sr"), (sr===null) ? null : sr - (((b.income>0)?((b.income-b.expense)/b.income)*100:sr)));

    // sparklines (weekly buckets)
    const w = weeklySeries(txThis, ym);
    const wPrev = weeklySeries(txPrev, prevMonth(ym));

    drawSpark(document.getElementById("s_exp"), w.expense);
    drawSpark(document.getElementById("s_inc"), w.income);
    drawSpark(document.getElementById("s_net"), w.income.map((v,i)=> v - w.expense[i]));
    drawSpark(document.getElementById("s_sr"), w.income.map((v,i)=>{
      const inc=v, exp=w.expense[i];
      return inc>0 ? ((inc-exp)/inc)*100 : 0;
    }));

    // trend lines
    drawLines(document.getElementById("trend"), w.income, w.expense);

    // categories
    const cats = categoryTotals(txThis, 6);
    document.getElementById("cats").innerHTML = buildCatBars(cats, currency);
  }

  demoBtn.onclick = async ()=>{
    await seedIfEmpty(profileSel.value);
    await render();
  };

  buildMonthOptions();
  monthSel.value = thisMonth();
  render();

  onChanged((ev)=>{
    if(ev.scope === "transactions" || ev.scope === "settings") render();
  });
</script>
</body>
</html>
