<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PFOS Â· Transactions</title>
  <link rel="stylesheet" href="../assets/theme.css"/>
</head>
<body>
  <div class="container">
    <div class="widget">
      <div class="topbar">
        <div class="title">Transactions</div>
        <div class="controls">
          <div class="control">
            <label>Month</label>
            <select id="month"></select>
          </div>
          <div class="control">
            <label>Search</label>
            <input id="q" type="text" placeholder="merchant, category..."/>
          </div>
          <button class="btn primary" id="add">+ Add</button>
          <button class="btn" id="demo">Load demo data</button>
          <a class="btn" href="../">Home</a>
        </div>
      </div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th style="width:110px">Date</th>
              <th>Description</th>
              <th style="width:140px">Category</th>
              <th style="width:140px">Account</th>
              <th style="width:110px">Type</th>
              <th class="right" style="width:140px">Amount</th>
              <th style="width:110px">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="footerNote">Runs locally. No server-side storage.</div>
    </div>
  </div>

  <div class="drawer" id="drawer">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <h2 id="drawerTitle">Add transaction</h2>
      <button class="btn small" id="close">Close</button>
    </div>
    <div class="sep"></div>

    <div class="field">
      <div class="lbl">Date</div>
      <input id="f_date" type="date"/>
    </div>

    <div class="formRow">
      <div class="field">
        <div class="lbl">Type</div>
        <select id="f_type">
          <option>Expense</option>
          <option>Income</option>
          <option>Transfer</option>
        </select>
      </div>
      <div class="field">
        <div class="lbl">Amount</div>
        <input id="f_amount" type="number" step="1" min="0"/>
      </div>
    </div>

    <div class="field">
      <div class="lbl">Description</div>
      <input id="f_desc" type="text" placeholder="e.g., Groceries, Salary..."/>
    </div>

    <div class="formRow">
      <div class="field">
        <div class="lbl">Category</div>
        <select id="f_cat"></select>
      </div>
      <div class="field">
        <div class="lbl">Account</div>
        <select id="f_acc"></select>
      </div>
    </div>

    <div class="field">
      <div class="lbl">Notes (optional)</div>
      <input id="f_note" type="text" placeholder="optional"/>
    </div>

    <div class="sep"></div>
    <div style="display:flex; gap:10px; justify-content:space-between">
      <button class="btn danger" id="del" style="display:none">Delete</button>
      <div style="display:flex; gap:10px; margin-left:auto">
        <button class="btn" id="cancel">Cancel</button>
        <button class="btn primary" id="save">Save</button>
      </div>
    </div>
  </div>

<script type="module">
  import { thisMonth, fmtINR, todayISO } from "../assets/utils.js";
  import { getSettings, seedIfEmpty, listTransactionsByMonth, upsertTransaction, deleteTransaction, onChanged } from "../assets/state.js";

  const profile = "default";
  const monthSel = document.getElementById("month");
  const q = document.getElementById("q");
  const rows = document.getElementById("rows");

  const drawer = document.getElementById("drawer");
  const drawerTitle = document.getElementById("drawerTitle");
  const closeBtn = document.getElementById("close");
  const addBtn = document.getElementById("add");
  const demoBtn = document.getElementById("demo");

  const f_date = document.getElementById("f_date");
  const f_type = document.getElementById("f_type");
  const f_amount = document.getElementById("f_amount");
  const f_desc = document.getElementById("f_desc");
  const f_cat = document.getElementById("f_cat");
  const f_acc = document.getElementById("f_acc");
  const f_note = document.getElementById("f_note");
  const delBtn = document.getElementById("del");
  const cancelBtn = document.getElementById("cancel");
  const saveBtn = document.getElementById("save");

  let settings = null;
  let currency = "INR";
  let editingId = null;

  function buildMonthOptions(){
    const now = new Date();
    const months = [];
    for(let i=0;i<18;i++){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      months.push(ym);
    }
    monthSel.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join("");
  }

  function openDrawer(tx=null){
    drawer.classList.add("open");
    if(tx){
      editingId = tx.id;
      drawerTitle.textContent = "Edit transaction";
      delBtn.style.display = "inline-block";
      f_date.value = tx.date;
      f_type.value = tx.type || "Expense";
      f_amount.value = tx.amount || 0;
      f_desc.value = tx.desc || "";
      f_cat.value = tx.category || "";
      f_acc.value = tx.account || "";
      f_note.value = tx.note || "";
    }else{
      editingId = null;
      drawerTitle.textContent = "Add transaction";
      delBtn.style.display = "none";
      f_date.value = todayISO();
      f_type.value = "Expense";
      f_amount.value = "";
      f_desc.value = "";
      f_cat.value = settings.categories?.[0] || "Groceries";
      f_acc.value = settings.accounts?.[0] || "Bank";
      f_note.value = "";
    }
  }
  function closeDrawer(){ drawer.classList.remove("open"); }

  function match(tx, needle){
    if(!needle) return true;
    const s = needle.toLowerCase();
    return (tx.desc||"").toLowerCase().includes(s)
      || (tx.category||"").toLowerCase().includes(s)
      || (tx.account||"").toLowerCase().includes(s)
      || (tx.type||"").toLowerCase().includes(s);
  }

  async function render(){
    settings = await getSettings(profile);
    currency = settings.currency || "INR";
    // populate selects
    f_cat.innerHTML = (settings.categories||[]).map(c=>`<option>${c}</option>`).join("");
    f_acc.innerHTML = (settings.accounts||[]).map(a=>`<option>${a}</option>`).join("");

    const ym = monthSel.value;
    const tx = await listTransactionsByMonth(profile, ym);
    const needle = q.value.trim();
    const filtered = tx.filter(t=> match(t, needle));

    if(filtered.length === 0){
      rows.innerHTML = `<tr><td colspan="7" style="color:rgba(234,241,255,.60); padding:16px">No transactions found.</td></tr>`;
      return;
    }

    rows.innerHTML = filtered.map(t=>`
      <tr>
        <td class="mono">${t.date}</td>
        <td>${escapeHtml(t.desc||"")}</td>
        <td><span class="pill">${escapeHtml(t.category||"")}</span></td>
        <td><span class="pill">${escapeHtml(t.account||"")}</span></td>
        <td>${escapeHtml(t.type||"")}</td>
        <td class="right mono">${fmtINR(t.amount||0, currency)}</td>
        <td>
          <button class="btn small" data-edit="${t.id}">Edit</button>
        </td>
      </tr>
    `).join("");

    rows.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.getAttribute("data-edit");
        const txAll = await listTransactionsByMonth(profile, ym);
        const found = txAll.find(x=>x.id===id);
        if(found) openDrawer(found);
      };
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  addBtn.onclick = ()=> openDrawer(null);
  closeBtn.onclick = closeDrawer;
  cancelBtn.onclick = closeDrawer;

  saveBtn.onclick = async ()=>{
    const tx = {
      id: editingId || undefined,
      date: f_date.value,
      type: f_type.value,
      amount: Number(f_amount.value || 0),
      desc: f_desc.value,
      category: f_cat.value,
      account: f_acc.value,
      note: f_note.value
    };
    if(!tx.date || !tx.desc || !tx.amount){
      alert("Date, description, and amount are required.");
      return;
    }
    await upsertTransaction(profile, tx);
    closeDrawer();
    render();
  };

  delBtn.onclick = async ()=>{
    if(!editingId) return;
    if(!confirm("Delete this transaction?")) return;
    await deleteTransaction(editingId);
    closeDrawer();
    render();
  };

  demoBtn.onclick = async ()=>{ await seedIfEmpty(profile); render(); };

  q.oninput = ()=> render();

  buildMonthOptions();
  monthSel.value = thisMonth();
  monthSel.onchange = ()=> render();
  render();

  onChanged((ev)=>{
    if(ev.scope === "transactions" || ev.scope === "settings") render();
  });
</script>
</body>
</html>
